"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5978],{85978:function(e,t,i){i.d(t,{nC:function(){return L},or:function(){return I},rn:function(){return V}});var s=i(83466),a=i(85466),r=i.n(a),l=i(14698),n=i.n(l),o=i(55371),d=i.n(o),u=i(45470),c=i.n(u),g=i(44194),h=i(32689),p=i(48769),v=i(22669),f=i(85680),P=i(96932),m=i(95687);async function y(e){if(!e||e.hasNoACESEquivalent)return;let{specLink:t}=e;if(t)return t;try{let{specLink:t}=await (0,h.n)(f.K.garage.migrateVehicleToACES(e.id));return m.Vj.dispatch((0,P.pk)({...e,specLink:t})),t}catch(t){throw t instanceof s.dDE&&m.Vj.dispatch((0,P.pk)({...e,hasNoACESEquivalent:!0})),t}}var b=i(20465),E=i(22780),R=i(20406),S=i(18687),F=i(4891),A=i(51795),w=i(76317),q=i(24538),C=i(90543);let L="isFitted_uFilter";class I{onChange(e,t,i){if(e&&this.setInitialData(e),t&&!e||t&&!r()(t.filters,null==e?void 0:e.request.filters)){let{isNewRequest:e,canUseRequestForSearch:i}=this.inspectRequest(t);e&&i&&this.update({state:"has-pending-request",currentRequest:t,loadingProducts:!0,loadingPrices:!1,loadingACESFitments:!1,errorLoadingProducts:void 0})}let{state:s,currentRequest:a}=this.state$.getValue();"has-initial-data"===s&&i?this.continueLoadingInitialData():"has-pending-request"===s&&i&&a&&this.load(a,!a.page,a.page)}setInitialData(e){var t,i;this.update({state:"has-initial-data",page:1,nextOffset:(null!==(t=e.request.offset)&&void 0!==t?t:0)+(null!==(i=e.request.count)&&void 0!==i?i:e.results.products.length),currentRequest:e.request,currentResult:e.results,loadingProducts:!1,errorLoadingProducts:void 0,products:e.results.products,metadata:this.getMetadata(e.request,e.results),loadingPrices:!0,errorLoadingPrices:void 0,prices:new Map,activePage:1,builders:e.results.builders})}loadNextPage(e){let t=this.state$.getValue();t.currentRequest&&!t.loadingProducts&&this.load(t.currentRequest,!1,e)}async loadNextAvailabilityPage(){let e=this.state$.getValue();e.currentRequest&&!e.loadingProducts&&await this.load(e.currentRequest,!1,0,!0)}continueLoadingInitialData(){let e=this.state$.getValue();if("has-initial-data"!==e.state||!e.currentRequest||!e.currentResult)throw Error("Cannot call continueLoadingInitialData if there is no initial data set");let{products:t}=e,{interchangeableParts:i,unbxdRequestId:s}=e.currentResult,a=t.length>0?t:i;this.loadPriceAndFitment(null!=a?a:[],!0,this.sddZip).then(e=>{var i,a,r,l;let n="success"===e.prices.type?e.prices.result:void 0,o="success"===e.fitments.type?e.fitments.result:void 0;null===(i=(a=this.options).onAfterReload)||void 0===i||i.call(a,{page:1,products:t,prices:n,acesFitments:o,unbxdRequestId:s}),null===(r=(l=this.options).onLoadPage)||void 0===r||r.call(l,{page:1,products:t,prices:n,acesFitments:o,unbxdRequestId:s})})}inspectRequest(e){let t=this.state$.getValue();return{isNewRequest:!(t.currentRequest&&this.areSearchRequestsEqual(t.currentRequest,t.currentResult,e)),canUseRequestForSearch:!!(e.term||e.categoryGroupId||e.products||e.brand||e.interchangePartNumber)}}getResultWithSortedFacets(e){return e.filters.facets.map((t,i)=>("unbxd_DeliveryMethod_uFilter"===t.id&&(e.filters.facets.splice(i,1),e.filters.facets.unshift(t)),e.filters.facets)),e}async load(e,t,i,s){var a,r,l,n,o;let d;t&&(null===(a=(r=this.options).onBeforeReload)||void 0===a||a.call(r));let u=this.state$.getValue();this.update({state:"loading-products",page:t||s?1:i,currentRequest:e,loadingProducts:!0,errorLoadingProducts:void 0,...s?void 0:{products:[]},acesFitments:t?new Map:u.acesFitments});let c=await this.getAvailabilityStoreIdIfInStockIsApplied(e);if(d=c?{...await this.loadProductsWithAvailability(e,c,t,s),page:1}:await this.loadProducts(e,t,i)){let e=null!==(n=d.page)&&void 0!==n?n:1,i=(null!==(o=null===(l=d.newProducts)||void 0===l?void 0:l.length)&&void 0!==o?o:0)>0?d.newProducts:d.interchangeableParts;this.loadPriceAndFitment(null!=i?i:[],t,this.sddZip).then(s=>{var a,r,l,n;let o="success"===s.prices.type?s.prices.result:void 0,u="success"===s.fitments.type?s.fitments.result:void 0;t&&(null===(l=(n=this.options).onAfterReload)||void 0===l||l.call(n,{page:1,products:null!=i?i:[],prices:o,acesFitments:u,unbxdRequestId:d.unbxdRequestId})),null===(a=(r=this.options).onLoadPage)||void 0===a||a.call(r,{page:e,products:null!=i?i:[],prices:o,acesFitments:u,unbxdRequestId:d.unbxdRequestId})})}}async getUsersDefaultStore(){let e;try{e=await (0,h.n)(f.K.store.getDefaultStoreId())}catch(e){(0,w.Nd)(e,{aapEventName:"noticeError",aapFailedMethodName:"getUsersDefaultStore",aapComponent:"useProducts"})}return e}async getAvailabilityStoreIdIfInStockIsApplied(e){var t,i;let{default:s,dataState:a}=(0,q.O3)(m.Vj.getState()),r=null==s?void 0:s.id;if("loaded"!==a&&(r=await this.getUsersDefaultStore()),r&&(null===(i=e.filters)||void 0===i?void 0:null===(t=i.filter(e=>"unbxd_DeliveryMethod_uFilter"===e.key)[0])||void 0===t?void 0:t.value.toLocaleLowerCase())==="free in-store pickup")return r}async loadProducts(e,t,i){let s=this.state$.getValue(),a=t?1:i,r=i?(i-1)*v.PP:s.nextOffset;r=t?0:r;let l={...this.addProductIdFilters(e),offset:r};try{var n,o;let t=await (0,h.n)(f.K.search.search(l)),d=this.getResultWithSortedFacets(t),u={...d,page:i};if(this.state$.getValue().currentRequest!==e)return;let c=this.getMetadata(l,d),{products:g}=d;null===(n=(o=this.options).onNewResult)||void 0===n||n.call(o,u);let p=s.currentResult,v=null==d?void 0:d.builders;return this.update({state:"loading-prices",nextOffset:r+e.count,loadingProducts:!1,errorLoadingProducts:void 0,products:g,currentResult:d,metadata:c,activePage:null!=i?i:1,builders:v}),this.sendRecommendationsDataIfNeeded(e,p,d),{unbxdRequestId:d.unbxdRequestId,newProducts:d.products,page:a,interchangeableParts:d.interchangeableParts,usedVehicle:d.usedVehicle}}catch(e){this.update({loadingProducts:!1,errorLoadingProducts:e})}}async loadProductsWithAvailability(e,t,i,s){var a,r,l;let n=this.state$.getValue(),o=s&&n.currentResult&&(null===(a=n.currentResult)||void 0===a?void 0:a.pageToken);s||this.update({products:void 0,currentResult:void 0});let d={...this.addProductIdFilters(e),...o?{pageToken:o}:void 0};try{let i=await (0,h.n)(f.K.search.searchWithInventory({...d,storeIds:[t]})),a=this.getResultWithSortedFacets({...i,numberOfProducts:i.products.length}),o={...a};if(this.state$.getValue().currentRequest!==e)return;let u=this.getMetadata(d,a),{products:c}=a;null===(r=(l=this.options).onNewResult)||void 0===r||r.call(l,o);let g=n.currentResult,p=s?null==g?void 0:g.products.concat(c):c,v=null==a?void 0:a.builders;return this.update({state:"loading-prices",loadingProducts:!1,errorLoadingProducts:void 0,products:p,currentResult:{...a,products:p||[]},metadata:u,builders:v}),this.sendRecommendationsDataIfNeeded(e,g,a),{unbxdRequestId:a.unbxdRequestId,newProducts:p,interchangeableParts:a.interchangeableParts,usedVehicle:a.usedVehicle}}catch(e){this.update({loadingProducts:!1,errorLoadingProducts:e})}}async loadACESFitment(e,t){let i=new Map,a=this.state$.getValue(),{defaultVehicle:r}=(0,P.iy)(m.Vj.getState());if(!r)return i;let{specLink:l}=r;if(!l)try{l=await y(r)}catch(e){e instanceof s.dDE?b.j.event.productListPage.onMissingACESEquivalent(r.id):(0,w.Nd)(e,{message:"Error during ACES migration"})}if(!l||0===e.length)return this.update({state:this.state$.getValue().loadingPrices?"loading-prices":"loaded"}),i;this.update({state:"loading-aces-fitments",loadingACESFitments:!0,acesFitments:t?new Map:a.acesFitments,errorLoadingACESFitments:void 0});try{return(await (0,h.n)(f.K.product.checkFitmentForACESVehicle(e,l,{provideAlternativeProducts:!1}))).forEach((e,t)=>i.set(t.id,e)),this.update({state:this.state$.getValue().loadingPrices?"loading-prices":"loaded",loadingACESFitments:!1,acesFitments:new Map([...a.acesFitments,...i])}),i}catch(e){this.update({loadingACESFitments:!1,errorLoadingACESFitments:e})}}async reloadAcesFitments(){let e=this.state$.getValue(),{currentRequest:t}=e;t&&!e.loadingProducts&&await this.load(t,!1,1)}async reloadPricesByStore(){let e=this.state$.getValue(),{currentRequest:t}=e;t&&!e.loadingProducts&&await this.load(t,!1,1)}async loadPriceAndFitment(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(!this.loadAdditionalData)return{prices:{type:"success",result:new Map},fitments:{type:"success",result:new Map},deliveries:{type:"success",result:[]}};let[s,a,r]=await Promise.all([this.loadPrices(null!=e?e:[],t).then(e=>({type:"success",result:e}),e=>((0,w.Nd)(e,{message:"Error loading prices"}),{type:"error",result:void 0})),this.loadACESFitment(null!=e?e:[],t).then(e=>({type:"success",result:e}),e=>((0,w.Nd)(e,{message:"Error loading aces fitment"}),{type:"error",result:void 0})),(null==e?void 0:e.length)&&this.loadSDDEligibility(null!=e?e:[],i).then(e=>e)]);return{prices:s,fitments:a,deliveries:r}}async loadSDDEligibility(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=this.prepareEligibilityObj(e),s=await (0,h.n)(f.K.delivery.checkEligibility({zip:t,items:i}));return this.update({deliveries:s}),s}prepareEligibilityObj(e){return e.map(e=>({sku:e.id,quantity:1}))}async loadPrices(e,t){let i=this.state$.getValue(),s=i.products;this.update({state:"loading-prices",loadingPrices:!0,prices:t?new Map:i.prices,errorLoadingPrices:void 0});try{let{storePromotionEnabled:t,defaultStoreId:i}=await (0,C.UJ)(this.configClearanceEligibleStoreList);this.update({storePromotionEnabled:t});let a=t&&i?f.K.productPricing.getPricesForProductsForStore(e,"none",i):f.K.productPricing.getPricesForProducts(e),{prices:r}=await (0,h.n)(a),l=this.state$.getValue(),n=new Map;return l.prices.forEach(e=>n.set(e.id,e)),r.forEach(e=>n.set(e.id,e)),s===l.products&&this.update({state:this.state$.getValue().loadingACESFitments?"loading-aces-fitments":"loaded",loadingPrices:!1,prices:n}),n}catch(e){this.update({loadingPrices:!1,errorLoadingPrices:e})}}sendRecommendationsDataIfNeeded(e,t,i){var s;let a=null!==(s=null==t?void 0:t.products.map(e=>e.id))&&void 0!==s?s:[],r=i.products.map(e=>e.id),l=0!==c()(a,r).length,n=i.usedVehicle.id,o=(null==t?void 0:t.usedVehicle.id)!==n;if(l||o){let t=this.recommendationSpots(e,i);return(0,R.Jj)({spots:t,vehicleId:n,excludedItemIds:r})}}recommendationSpots(e,t){return 0===t.products.length?[s.Qx0.NoSearchResults1,s.Qx0.NoSearchResults2]:e.categoryPath?[s.Qx0.CategorySearch]:[]}addProductIdFilters(e){if(!e.term||!v.LJ.test(e.term))return e;let t=e.term.split(/\s+OR\s+/i);return{...e,products:t}}areSearchRequestsEqual(e,t,i){var s,a,l,o;let u=d()({...e,filters:[...null!==(s=e.filters)&&void 0!==s?s:[],...null!==(a=null==t?void 0:t.addedFilters)&&void 0!==a?a:[]]},n()),c=d()({...e,filters:null!==(l=e.filters)&&void 0!==l?l:[]},n()),g=d()({...i,filters:null!==(o=i.filters)&&void 0!==o?o:[]},n());return r()(c,g)||r()(u,g)}getMetadata(e,t){var i,s,a,r,l,n;let o=e.term,d=t.products,u=void 0===e.offset||0===e.offset,{facets:c}=t.filters,g=c.find(e=>e.id===L),h=null!==(a=null==g?void 0:null===(i=g.values.find(e=>"Exact Fit"===e.value))||void 0===i?void 0:i.count)&&void 0!==a?a:0,p=null!==(r=null==g?void 0:null===(s=g.values.find(e=>"Not Fitted Products"===e.value))||void 0===s?void 0:s.count)&&void 0!==r?r:0,v=[...null!==(l=e.filters)&&void 0!==l?l:[],...t.addedFilters].find(e=>{let{key:t}=e;return t===L});return{isFirstPage:u,isLastPage:(null!==(n=e.offset)&&void 0!==n?n:0)+d.length>=t.numberOfProducts,exactFitCount:h,notFittedCount:p,originalSearchPhrase:o,isExactFitSelected:(null==v?void 0:v.value)==="Exact Fit",isNotFittedSelected:(null==v?void 0:v.value)==="Not Fitted Products"}}update(e){this.state$.next({...this.state$.getValue(),...e})}constructor(e,t,i,s,a){this.options=e,this.loadAdditionalData=!0,this.state$=new p.X({state:"waiting-for-request",page:t,nextOffset:0,loadingProducts:!0,products:[],metadata:void 0,loadingPrices:!1,prices:new Map,loadingACESFitments:!1,acesFitments:new Map,activePage:t,deliveries:{deliveryEligibleProducts:[],isZipCodeEligibleForSdd:!1},builders:[],storePromotionEnabled:!1}),this.sddZip=i,this.configClearanceEligibleStoreList=s,this.loadAdditionalData=null==a||a}}function V(e,t,i,s){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,l=!(arguments.length>5)||void 0===arguments[5]||arguments[5],{configClearanceEligibleStoreList:n}=(0,A.V)(),o=(0,g.useRef)(s);o.current=s;let d=(0,S.J)(),[u]=(0,g.useState)(()=>{let s=new I({onAfterReload:function(){for(var e,t,i=arguments.length,s=Array(i),a=0;a<i;a++)s[a]=arguments[a];return null===(e=(t=o.current).onAfterReload)||void 0===e?void 0:e.call(t,...s)},onBeforeReload:function(){for(var e,t,i=arguments.length,s=Array(i),a=0;a<i;a++)s[a]=arguments[a];return null===(e=(t=o.current).onBeforeReload)||void 0===e?void 0:e.call(t,...s)},onLoadPage:function(){for(var e,t,i=arguments.length,s=Array(i),a=0;a<i;a++)s[a]=arguments[a];return null===(e=(t=o.current).onLoadPage)||void 0===e?void 0:e.call(t,...s)},onNewResult:function(){for(var e,t,i=arguments.length,s=Array(i),a=0;a<i;a++)s[a]=arguments[a];return null===(e=(t=o.current).onNewResult)||void 0===e?void 0:e.call(t,...s)}},a,d,n,l);return s.onChange(e,t,i),s}),[c,h]=(0,g.useState)(u.state$.getValue());(0,g.useEffect)(()=>{let e=u.state$.subscribe(e=>h(e),e=>console.error("Error in controller state",e),()=>console.error("Controller state completed, this should not happen"));return u.configClearanceEligibleStoreList=n,()=>e.unsubscribe()},[u,n]);let p=(0,F._)();(0,E.S)((e,t)=>{let[i,s,a]=e,[l,n,o]=t,d=r()(i,l)?void 0:l,c=r()(s,n)?void 0:n;u.onChange(d,c,o)},[e,t,i]);let v=(0,g.useCallback)(e=>{let t=c.prices.get(e);return{loading:!t&&c.loadingPrices,error:t?void 0:c.errorLoadingPrices,item:t}},[c.prices,c.loadingPrices,c.errorLoadingPrices]),f=async e=>(u.sddZip=e,u.loadSDDEligibility(c.products,e)),P=(0,g.useCallback)(e=>{var t,i;return{item:c.deliveries.deliveryEligibleProducts&&c.deliveries.deliveryEligibleProducts.find(t=>t.sku===e),cutOffTime:null===(t=c.deliveries)||void 0===t?void 0:t.cutOffTime,storeTimeZone:null===(i=c.deliveries)||void 0===i?void 0:i.storeTimeZone}},[c.deliveries]),m=(0,g.useCallback)(e=>{let t=c.acesFitments.get(e);return{loading:c.loadingACESFitments,error:t?void 0:c.errorLoadingACESFitments,item:t}},[c.acesFitments,c.errorLoadingACESFitments,c.loadingACESFitments]),y=async(e,t)=>{let{bundle:i,...s}=p.query;await p.push({pathname:p.asPath.split("?")[0],query:{...s,[e]:t}},{shallow:!0})};return{metadata:c.metadata,lastResult:c.currentResult,loading:!i||c.loadingProducts,products:c.products,error:c.errorLoadingProducts,loadNext:e=>{e&&y("page",e).then(()=>{u.loadNextPage(e)}).catch(()=>{u.loadNextPage(e)})},loadNextAvailability:()=>u.loadNextAvailabilityPage(),getPrice:v,getDelivery:P,getACESFitment:m,activeSelectedPage:c.activePage,reloadAcesFitments:()=>u.reloadAcesFitments(),updateSDDEligibilityForZip:f,builders:c.builders,storePromotionEnabled:c.storePromotionEnabled,reloadPricesByStore:()=>u.reloadPricesByStore()}}}}]);